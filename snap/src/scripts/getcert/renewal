#!/bin/dash
# this is the deploy hook that cerbot calls after successfully renewing a certificate
set -x

SNAPCTL=snapctl

#temp hacks
#SNAP_NAME=tomcat-with-sll
#SNAPCTL=snap
#end hacks	

# after a cert renewal we need to export the keys so tomcat can access them.

KEYSTORE_PWD="`${SNAPCTL}` get keystorepwd"
FQDN="`${SNAPCTL}` get fqdn"

# re-create pkcs12 store
openssl pkcs12 -export \
  -in ${SNAP_USER_DATA}/letsencrypt/config/live/${FQDN}/fullchain.pem \
  -inkey ${SNAP_USER_DATA}/letsencrypt/config/live/${FQDN}/privkey.pem \
  -out ${SNAP_USER_DATA}/keystore/${FQDN}.p12 \
 -password pass:${KEYSTORE_PWD}


${SNAPCTL} restart
