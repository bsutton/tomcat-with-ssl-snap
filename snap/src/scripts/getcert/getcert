#!/bin/dash
set -x

#temp hacks
SNAPNAME=tomcat-with-ssl
#end hacks	

# If no arguments, print usage statement & exit from function
if [ "$#" -ne "2" ]; then
	echo
	echo "Usage: getcert <emailaddress> <fqdn> "
	echo
	echo "Runs runs certbot to obtain an SSL certificate for <fqdn>."
	echo  The email address is used by letsencrypt to notify you of certificate issues.
	echo
	echo "<emailaddress> the email address for letsencrypt to send notifications to"
	echo "<fqdn> the fqdn to request a certificate for."
	exit 1 
fi


EMAIL=$1
FQDN=$2

# generate random password for keystore
KEYSTOREPWD=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 32 | head -n 1)
KEYSTORE_DIR=${SNAP_DATA}/keystore

#mkdir -p ${SNAP_DATA}/letsencrypt/live/${FQDN}

# check if the certificate already exists and if so lets delete it.
# if we don't delete the cert dir certbot will use a different name so our later steps won't find the certs.
if [ -e "${SNAP_DATA}/letsencrypt/live/${FQDN}" ]; then
	echo rm -rf "${SNAP_DATA}/letsencrypt/live/${FQDN}"
	#rm -rf "${SNAP_DATA}/letsencrypt/live/${FQDN}"
	#certbot delete --cert-name home.noojee.org
fi

# Need to take control of port 80 for cert validation
snap stop ${SNAP_NAME}.tomcat

# run cert bot to obtain certificates
certbot certonly \
	 --standalone \
	 --noninteractive \
	 --domain ${FQDN} \
	 --agree-tos \
	 --email ${EMAIL} \
	 --config-dir=${SNAP_DATA}/letsencrypt/config \
	 --work-dir=${SNAP_DATA}/letsencrypt/work \
	 --logs-dir=${SNAP_DATA}/letsencrypt/logs \
	 --cert-path ${SNAP_DATA}/letsencrypt/live/${fQDN} \
	 --key-path  ${SNAP_DATA}/letsencrypt/live/${fQDN} \
	 --fullchain-path  ${SNAP_DATA}/letsencrypt/live/${fQDN} 
	 #--test-cert \
	 #--staging
	 #--dry-run \


mkdir -p ${KEYSTORE_DIR}

# create pkcs12 store
openssl pkcs12 -export \
  -in ${SNAP_DATA}/letsencrypt/live/${FQDN}/fullchain.pem \
  -inkey ${SNAP_DATA}/letsencrypt/live/${FQDN}/privkey.pem \
  -out ${KEYSTORE_DIR}/${FQDN}.p12 \
 -password pass:${KEYSTOREPWD}

KEYSTORE=${KEYSTORE_DIR}/${FQDN}.keystore 

# delete the key store so we can recreate it
rm ${KEYSTORE}

#keytool -genkey -alias ${FQDN} -keyalg RSA -keystore ${KEYSTORE} -keysize 2048

# we reset the keystore password each time
# this is destructive if anyone else is using the keystore but we 
# created this one so bad luck
#keytool -storepasswd \
	#-new "${KEYSTOREPWD}" \
	#-keystore "${KEYSTORE_DIR}/${FQDN}.keystore"

# import pkcs12 store int java keystore.
keytool -importkeystore \
 -noprompt \
 -srckeystore ${KEYSTORE_DIR}/${FQDN}.p12 \
 -srcstoretype pkcs12 \
 -srcstorepass ${KEYSTOREPWD} \
 -destkeystore ${KEYSTORE_DIR}/${FQDN}.keystore \
 -deststoretype jks \
 -deststorepass ${KEYSTOREPWD}

SERVERXML="${SNAP_DATA}/conf/server.xml"
SERVERXML_BACKUP="${SNAP_DATA}/conf/server.xml.backup"
if [ -e "${SERVERXML_ORG}" ]; then
	echo "server.xml already backedup"
else
	 mkdir -p ${SNAP_DATA}/conf
	 cp ${SERVERXML} ${SERVERXML_BACKUP}
fi

# overwrite the default tomcat config file with our SSL enabled one along with the keystore password
sed  -e 's,%FQDN%,'${FQDN}',g' \
	-e 's,%KEYSTOREPWD%,'${KEYSTOREPWD}',g' \
	-e 's,%KEYSTORE%,'${KEYSTORE_DIR}',g' \
	< ${SNAP}/tomcat-with-ssl.xml \
	> "${SERVERXML}"

# The certbot renewal process needs these.
snapctl set KEYSTOREPWD=${KEYSTOREPWD}
snapctl set FQDN=${FQDN}

snap restart ${SNAP_NAME}.tomcat
